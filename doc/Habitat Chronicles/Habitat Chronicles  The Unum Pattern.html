<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class=" idcae idcac"><head>
    <title>Habitat Chronicles:   The Unum Pattern</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-style-type" content="text/css">
    <meta http-equiv="content-script-type" content="text/javascript">
    <link rel="stylesheet" media="handheld" type="text/css" href="resources/handheld.css">
    <link rel="stylesheet" media="print" type="text/css" href="resources/print.css">
    <link rel="stylesheet" media="screen" type="text/css" href="resources/style_002.css">
    <link rel="stylesheet" type="text/css" media="screen" href="resources/comments.css"><link rel="alternate" type="application/rss+xml" title="Habitat Chronicles RSS Feed" href="http://habitatchronicles.com/feed/">
    <link rel="pingback" href="http://habitatchronicles.com/blog/xmlrpc.php">
    <link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Habitat Chronicles » The Unum Pattern Comments Feed" href="http://habitatchronicles.com/2019/08/the-unum-pattern/feed/">
		<script src="resources/wp-emoji-release.js" type="text/javascript" defer="defer"></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel="stylesheet" id="wp-block-library-css" href="resources/style.css" type="text/css" media="all">
<script type="text/javascript" src="resources/jquery.js"></script>
<script type="text/javascript" src="resources/jquery-migrate.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var AJAXCommentPreview = {"loading":"Loading\u2026","error":"Preview error","emptyString":"Click the \"Preview\" button to preview your comment here.","url":"http:\/\/habitatchronicles.com\/blog\/wp-admin\/admin-ajax.php?action=ajax_comment_preview"};
/* ]]> */
</script>
<script type="text/javascript" src="resources/ajax-comment-preview.js"></script>
<link rel="https://api.w.org/" href="http://habitatchronicles.com/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://habitatchronicles.com/blog/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://habitatchronicles.com/blog/wp-includes/wlwmanifest.xml">
<link rel="prev" title="Another Thing Found While Packing to Move" href="http://habitatchronicles.com/2019/05/another-thing-found-while-packing-to-move/">
<link rel="canonical" href="http://habitatchronicles.com/2019/08/the-unum-pattern/">
<link rel="shortlink" href="http://habitatchronicles.com/?p=511">
<link rel="alternate" type="application/json+oembed" href="http://habitatchronicles.com/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhabitatchronicles.com%2F2019%2F08%2Fthe-unum-pattern%2F">
<link rel="alternate" type="text/xml+oembed" href="http://habitatchronicles.com/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhabitatchronicles.com%2F2019%2F08%2Fthe-unum-pattern%2F&amp;format=xml">
    <!--[if IE]>
      <style type="text/css">
          div#container {
              max-width:1200px;
              width:expression(document.body.clientWidth > 1200? "1200px": "99%" );
          }
      </style>
    <![endif]-->
</head>
<body>

  <div id="banner">
    <div id="banner-inner" class="pkg">
      <h1 id="banner-header"><a href="http://habitatchronicles.com/">Habitat Chronicles</a></h1>
      <h2 id="banner-description">Cyberspace. Virtual communities. Online games. Distributed systems.<br>Opinion, history, advice, and silliness from two guys who've been building this stuff for a long, long time.</h2>
    </div>
  </div>

  <div id="container">
<div id="navigation">
    <div class="module" style="margin-top: 0;">
        <h2 class="module-header">Say what?</h2>
        <div class="module-content module-content-simple">
    In 1985 we began work on what would become one of the world's first
    multi-person graphical virtual worlds, and arguably the first of what are
    now awkwardly called "Massively Multiplayer Online Role Playing Games"
    (MMORPGs).  Thus began a series of adventures in technology, business, and
    the online world which continue to this day.  This site is where we tell
    our story: the things we learned, the mistakes we made, the people we met,
    a tale of human brilliance and folly and things you would never have
    imagined. <br>
    <br>
    <a href="http://www.fudco.com/chip/resume.html">About Chip Morningstar</a><br>
    <a href="http://www.linkedin.com/in/frandallfarmer">About Randy Farmer</a><br>
    <a href="http://www.fudco.com/chip/lessons.html">About Habitat</a><br>

        </div>
    </div>


    <div class="module">
        <h2 class="module-header">Collected History</h2>
        <div class="module-content">
           <p><a href="http://www.fudco.com/chip/lessons.html">The Lessons of Lucasfilm's Habitat</a></p>
           <p><a href="http://www.fudco.com/chip/deconstr.html">How to Deconstruct Almost Anything</a></p>
           <p><a href="http://habitatchronicles.com/Habitat/historical/HabitatRedux.ppt">MDC 2004: Habitat Redux</a></p>
           <p><a href="http://habitatchronicles.com/Habitat/historical/ProtocolReqs-2-27-95.pdf">1994: Cyberspace Protocol Requirements</a></p>
        </div>
    </div>


    <div class="module"><h2 class="module-header">Blogs We Like</h2><div class="module-content">
	<ul class="xoxo blogroll">
<li><a href="http://www.durhamtownship.com/" title="Chip’s favorite photoblog" target="_blank"><p>A Walk Through Durham Township</p></a></li>
<li><a href="http://citycomfortsblog.typepad.com/" title="Wise meditations on city design — surprisingly relevant to virtual worlds" target="_blank"><p>City Comforts</p></a></li>
<li><a href="http://metamodern.com/" title="Meditations on the future from one of the smartest people on the planet" target="_blank"><p>Eric Drexler</p></a></li>
<li><a href="http://blog.massengale.com/" title="An architect on architecture" target="_blank"><p>John Massengale</p></a></li>
<li><a href="http://www.lessig.org/new-blog/" title="One of the good guys (most of the time)" target="_blank"><p>Lawrence Lessig</p></a></li>
<li><a href="http://www.raphkoster.com/" title="Raph knows more about online gaming than you do.  Just trust us on this." target="_blank"><p>Raph Koster</p></a></li>
<li><a href="http://grumpygamer.com/" title="Our pal and former coworker from Lucasfilm, and one of the best game designers anywhere" target="_blank"><p>Ron Gilbert — Grumpy Gamer</p></a></li>
<li><a href="http://terranova.blogs.com/terra_nova/" title="Where virtual world designers go to die" target="_blank"><p>Terra Nova</p></a></li>
<li><a href="http://classicist.blogs.com/" title="ICA&amp;CA’s house blog, for those of us concerned about the continued health of western culture" target="_blank"><p>The Classicist</p></a></li>
<li><a href="http://thedailywtf.com/" title="IT horrors to make your eyes bleed" target="_blank"><p>The Daily WTF</p></a></li>
<li><a href="https://www.washingtonpost.com/news/volokh-conspiracy/" title="Always interesting, even though they’re all lawyers" target="_blank"><p>The Volokh Conspiracy</p></a></li>
<li><a href="http://vpostrel.com/" title="Contrarian culture blogger non pareil" target="_blank"><p>Virginia Postrel</p></a></li>

	</ul>
</div></div>
<div class="module"><h2 class="module-header">Worthy Things</h2><div class="module-content">
	<ul class="xoxo blogroll">
<li><a href="http://www.crockford.com/" title="Save the earth for valuable prizes!" target="_blank"><p>Douglas Crockford's Wrrrld Wide Web</p></a></li>
<li><a href="http://www.well.com/~doctorow/metacrap.htm" title="Cory speaks truth to utopian W3C weenies" target="_blank"><p>Metacrap</p></a></li>
<li><a href="http://erights.org/" title="Electric Communities’ greatest legacy" target="_blank"><p>The E Programming Language</p></a></li>

	</ul>
</div></div>

    <div class="module">
        <h2 class="module-header">Search</h2>
        <div class="module-content module-content-simple">
            <form method="get" id="searchform" action="http://habitatchronicles.com">
    <fieldset>
        <label for="s">
            Habitat Chronicles search
            <br>
            <input type="text" size="20" name="s" id="s">
            <input type="submit" id="searchsubmit" value="Search">
        </label>
    </fieldset>
</form>
        </div>
    </div>

    <div class="module">
        <h2 class="module-header">Categories</h2>
        <div class="module-content module-content-simple">
            <ul>
                	<li class="cat-item cat-item-3"><a href="http://habitatchronicles.com/category/administrivia/">Administrivia</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://habitatchronicles.com/category/avatar/">Avatar</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://habitatchronicles.com/category/biz/">Business</a>
</li>
	<li class="cat-item cat-item-6"><a href="http://habitatchronicles.com/category/education/">Education</a>
</li>
	<li class="cat-item cat-item-7"><a href="http://habitatchronicles.com/category/elsewhere/">Elsewhere</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://habitatchronicles.com/category/food/">Food</a>
</li>
	<li class="cat-item cat-item-9"><a href="http://habitatchronicles.com/category/general/">General</a>
</li>
	<li class="cat-item cat-item-10"><a href="http://habitatchronicles.com/category/history/">History</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://habitatchronicles.com/category/lessons-learned/">Lessons Learned</a>
</li>
	<li class="cat-item cat-item-12"><a href="http://habitatchronicles.com/category/news/">News</a>
</li>
	<li class="cat-item cat-item-13"><a href="http://habitatchronicles.com/category/open/">Open</a>
</li>
	<li class="cat-item cat-item-14"><a href="http://habitatchronicles.com/category/politics/">Politics</a>
</li>
	<li class="cat-item cat-item-15"><a href="http://habitatchronicles.com/category/random/">Random Lunacy</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://habitatchronicles.com/category/random-lunacy/">Random Lunacy</a>
</li>
	<li class="cat-item cat-item-16"><a href="http://habitatchronicles.com/category/speaking/">Speaking</a>
</li>
	<li class="cat-item cat-item-17"><a href="http://habitatchronicles.com/category/tech/">Technology</a>
</li>
	<li class="cat-item cat-item-18"><a href="http://habitatchronicles.com/category/theory/">Theory</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://habitatchronicles.com/category/uncategorized/">Uncategorized</a>
</li>
            </ul>
        </div>
    </div>

    <div class="module">
        <h2 class="module-header">Archives</h2>
        <div class="module-content module-content-simple">
            <ul>
                	<li><a href="http://habitatchronicles.com/2019/08/">August 2019</a></li>
	<li><a href="http://habitatchronicles.com/2019/05/">May 2019</a></li>
	<li><a href="http://habitatchronicles.com/2019/03/">March 2019</a></li>
	<li><a href="http://habitatchronicles.com/2018/01/">January 2018</a></li>
	<li><a href="http://habitatchronicles.com/2017/11/">November 2017</a></li>
	<li><a href="http://habitatchronicles.com/2017/05/">May 2017</a></li>
	<li><a href="http://habitatchronicles.com/2017/02/">February 2017</a></li>
	<li><a href="http://habitatchronicles.com/2016/10/">October 2016</a></li>
	<li><a href="http://habitatchronicles.com/2014/10/">October 2014</a></li>
	<li><a href="http://habitatchronicles.com/2014/04/">April 2014</a></li>
	<li><a href="http://habitatchronicles.com/2014/03/">March 2014</a></li>
	<li><a href="http://habitatchronicles.com/2014/02/">February 2014</a></li>
	<li><a href="http://habitatchronicles.com/2013/12/">December 2013</a></li>
	<li><a href="http://habitatchronicles.com/2013/10/">October 2013</a></li>
	<li><a href="http://habitatchronicles.com/2013/08/">August 2013</a></li>
	<li><a href="http://habitatchronicles.com/2012/07/">July 2012</a></li>
	<li><a href="http://habitatchronicles.com/2011/04/">April 2011</a></li>
	<li><a href="http://habitatchronicles.com/2011/03/">March 2011</a></li>
	<li><a href="http://habitatchronicles.com/2011/01/">January 2011</a></li>
	<li><a href="http://habitatchronicles.com/2010/11/">November 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/10/">October 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/07/">July 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/03/">March 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/02/">February 2010</a></li>
	<li><a href="http://habitatchronicles.com/2009/12/">December 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/10/">October 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/09/">September 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/08/">August 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/07/">July 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/03/">March 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/02/">February 2009</a></li>
	<li><a href="http://habitatchronicles.com/2008/12/">December 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/11/">November 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/10/">October 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/09/">September 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/08/">August 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/06/">June 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/02/">February 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/01/">January 2008</a></li>
	<li><a href="http://habitatchronicles.com/2007/09/">September 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/07/">July 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/06/">June 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/05/">May 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/03/">March 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/01/">January 2007</a></li>
	<li><a href="http://habitatchronicles.com/2006/12/">December 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/11/">November 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/10/">October 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/09/">September 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/08/">August 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/06/">June 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/05/">May 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/03/">March 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/02/">February 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/01/">January 2006</a></li>
	<li><a href="http://habitatchronicles.com/2005/12/">December 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/11/">November 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/10/">October 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/09/">September 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/08/">August 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/05/">May 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/04/">April 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/03/">March 2005</a></li>
	<li><a href="http://habitatchronicles.com/2004/11/">November 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/10/">October 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/09/">September 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/07/">July 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/05/">May 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/04/">April 2004</a></li>
            </ul>
        </div>
    </div>

    <div class="module">
        <h2 class="module-header">Feed</h2>
        <div class="module-content module-content-simple">
            <ul class="rss">
                <li><a href="http://habitatchronicles.com/feed/" title="Feed for articles" style="text-decoration:none;">Subscribe to this blog's feed&nbsp;&nbsp;<img src="resources/feed-icon-28x28.png" alt="Feed" style="vertical-align:middle;" width="28" height="28"></a></li>
            </ul>
        </div>
    </div>

</div>
<div id="content"><h2 class="date-header">August 28, 2019</h2><div class="post-511 post type-post status-publish format-standard hentry category-history category-tech category-theory" id="post-511">
                <h3>The Unum Pattern</h3>

<p><em>Warning: absurd technical geekery ahead — even compared to the
kinds of things I normally talk about.  Seriously.  But things will be
back to my normal level of still-pretty-geeky-but-basically-approachable
 soon enough.</em></p>



<p>[Historical note: This post has been a long time in the making — the
roots of the fundamental idea being described here go back to the
original Habitat system (although we didn’t realize it at the time).  It
 describes a software design pattern for distributed objects — which we
call the “unum” — that I and some of my co-conspirators at various
companies have used to good effect in many different systems, but which
is still obscure even among the people who do the kinds of things I do.
 In particular, I’ve described this stuff in conversation with lots of
people over the years and a few of them have published descriptions of
what they understood, but their writeups haven’t, to my sensibilities at
 least, quite captured the idea as I conceive of it.  But I’ve only got
myself to blame for this as I’ve been lax in actually writing down my
own understanding of the idea, for all the usual reasons one has for not
 getting around to doing things one should be doing.]</p>



<p>Consider a distributed, multi-participant virtual world such as
Habitat or one of its myriad descendants.  This world is by its nature
very object oriented, but not in quite the same way that we mean when we
 talk about, for example, object oriented programming.  This is
confusing because the implementation is, itself, very object oriented,
in exactly the object oriented programming sense.</p>



<p>Imagine being in this virtual world somewhere, say, in a room in a
building in downtown Populopolis.  And there is a table in the room and
sitting on the table is a teacup.  Well, I said you were in the virtual
world, but you’re not really <em>in</em> it, your avatar is in it, and <em>you</em>
 are just interacting with it through the mediation of some kind of
client software running on your local computer (or perhaps these days on
 your phone), which is in turn communicating over a network connection
to a server somewhere.  So the question arises, where is the teacup, <em>really</em>?
  Certainly there is a representation of the teacup inside your local
computer, but there is also a representation of the teacup inside the
server.  And if I am in the room with you (well, my avatar, but that’s
not important right now), then there’s also a representation of the
teacup inside <em>my</em> local computer.  So is the teacup in your
computer or in my computer or in the server?  One reasonable answer is
“all of the above”, but in my experience a lot of technical people will
say that it’s “really” in the server, since they regard the server as
the source of truth. But the correct answer is that the teacup is on a
table in a room inside a building in Populopolis.  The teacup occupies a
 different plane of existence from the software objects that are used to
 realize it.  It has an objective identity of its own — if you and I
each refer to it, we are talking about the same teacup — but this
identity is entirely distinct from the identities of any of those
software objects.  And it <em>has</em> such an identity, because even
though it’s on a different plane there still needs to be some kind of
actual identifier that can be used in the communications protocols that
the clients and the server use to talk to each other, so that they can
refer to the teacup when they describe their manipulations of it and the
 things that happen to it.</p>



<figure class="wp-block-image"><img src="Habitat%20Chronicles%20%20The%20Unum%20Pattern_files/Fig-1-AnUnum-1024x968.png" alt="" class="wp-image-512" ><figcaption>Fig 1 – Our Little World</figcaption></figure>



<p>You might distinguish between these two senses of “object” by using
phrases with modifiers; for example, you might say “world object” versus
 “OOP object”, and in fact that is what we did for several years.
However, this terminology made it easy to fall back on the shorthand of
just talking about “objects” when it was clear from context which of
these two meanings of “object” you meant. Of course, it often turned out
 that this context <em>wasn’t</em> actually clear to <em>somebody</em>
in the conversation, with confusion and misunderstanding as the common
result.  So after a few false starts at crafting alternative jargon we
settled on using the term “object” to always refer to an OOP object in
an implementation and the term “unum”, from the latin meaning a single
thing, to refer to a world object.  This term has worked well for us,
aside from endless debates about whether the plural is properly “una” or
 “unums” (my opinion is: take your pick; people will know what you mean
either way).</p>



<p>Of course, we still have to explain the relationship between the unum
 and its implementation.  The objects (using that word from now on
according to our revised terminology) that realize the unum <em>do</em>
live at particular memory addresses in particular computers.  We think
of the unum, in contrast, as having a distributed existence.  We speak
of the portion of the unum that resides in a particular machine as a
“presence”.  So to go back to the example I started with, the teacup
unum has a presence on the server and presences on each of our client
machines.</p>



<figure class="wp-block-image"><img src="Habitat%20Chronicles%20%20The%20Unum%20Pattern_files/Fig-2-Presences-1024x903.png" alt="" class="wp-image-513" ><figcaption>Fig 2 – Presences</figcaption></figure>



<p>(As an aside, for the first few years of trying to explain to people
how Habitat worked, I would sometimes find myself in confused
discussions about “distributed objects”, by which the people with whom I
 was talking meant individual objects that were located at different
places on the network, whereas <em>I</em> meant objects that were
themselves distributed entities.  I didn’t at first realize these
conversations were at cross purposes because the model we had developed
for Habitat seemed natural and obvious to me at the time — how else
could it possibly work, after all? — and it took me a while to twig to
the fact that other people conceived of things in a very different way.
Another reason for introducing a new word.)</p>



<p>In the teacup example, we have a server presence and some number of
client presences.  The client presences are concerned with presenting
the unum to their local users while the server presence is concerned
with keeping track of that portion of the unum’s state which all the
users share.  Phrased this way, many people find the presence
abstraction very natural, but it sometimes leads them to jump to
conclusions about what is going on, resulting in still more confusion
and conversation at cross purposes.  People who implement distributed
systems often build on top of frameworks that provide services like data
 replication, and so it is easy to fall into thinking of the server
presence as the “real” version of the unum and the client presences as
shadow copies that maintain a (perhaps slightly out of date) cached
representation of the true state.  Or thinking of the client presences
as proxies of some kind.  This is not exactly <em>wrong</em>, in the
sense that you can certainly build systems that work this way, as many
distributed applications — possibly including most commercially
successful MMOs — actually do.  However, it’s not the model I’m
describing here.</p>



<p>One problem with data replication based schemes is that they don’t
gracefully accommodate use cases that require some information be
withheld from some participants (it’s not that you absolutely can’t do
this, but it’s awkward and cuts against the grain).  It’s not just that
the server is authoritative about shared state, but also that the server
 is allowed to take into account private state that the clients don’t
have, in order to determine how the shared state changes over time and
in response to events.</p>



<p>A server presence and a client presence are not doing the same job.
The fundamental underlying concept that presences embody is not some
notion of master vs. replica, but <em>division of labor</em>.  Each has
distinct responsibilities in the joint work of being the unum.  Each is
authoritative about different aspects of the unum’s existence (and
typically each will maintain private state of their own that they do not
 share with the other).  In the case of the client-server model in our
example, the client presence manages client-side concerns such as the
state of the display.  It worries about things like 3D rendering,
animation sequencing, and presenting controls to the human user to
manipulate the teacup with.  The server keeps track of things like the
physical model of the teacup within the virtual world.  It worries about
 the interactions between the teacup and the table, for example.  Each
presence knows things that are none of the other presence’s business,
either because that information is simply outside the scope of what the
other presence does (such as the current animation frame or the force
being applied to the table) or because it’s something the other presence
 is not supposed to know (such as the server knowing that this
particular teacup has a hidden flaw that will cause it to break into
several pieces if you pour hot water into it, revealing a secret message
 inscribed on the edges where it comes apart).  The various different
client presences may also have information they do not share with each
other for reasons of function or privacy.  For example, one client might
 do 3D rendering in a GUI window while another presents only a textual
description with a command line interface.  Perhaps the server has
revealed the secret message hidden in the teacup to my client (and to
none of the others) because I possess a magic amulet that lets me see
such things.</p>



<p>We can loosely talk about “sending a message to an unum”, but the
sending of messages is an OOP concept rather than a world model concept.
  Sending a message to an unum (which is not an object) is really
sending a message to some presence of that unum (since a presence <em>is</em>
 an object).  This means that to designate the target of such a message,
 the address needs two components: (1) the identity of the unum and (2)
an indicator of which presences of that unum you want to talk to.</p>



<p>In the systems I’ve implemented (including Habitat, but also, perhaps
 more usefully for anyone who wants to play with these ideas, its Nth
generation descendant, <a href="http://elkoserver.org/">the Elko server framework</a>),
 the objects on a machine within a given application all run inside a
common execution environment — what we now call a “vat”.  Cross-machine
messages are transported over communications channels established
between vats.  In such a system, from a vat’s perspective the external
presences of a given unum (that is, presences other than the local one)
are thus in one-to-one correspondence with the message channels to the
other vats that host those presences, so you can designate a presence by
 indicating the channel that leads to its vat.  (For those presences you
 can talk to, anyway: the unum model does not require that a presence be
 able to directly communicate with all the other presences.  For
example, in the case of a Habitat or Elko-style system such as I am
describing here, clients don’t talk to other clients, but only to the
server.)</p>



<p>Here we encounter an asymmetry between client and server that is
another frequent source of confusion.  From the client’s perspective,
there is only one open message channel — the one that talks to the
server — and so the only other unum presence a client knows about is the
 server presence.  In this situation, the identifier of the unum is
sufficient to determine where a message should be sent, since there is
only one possibility.  Developers working on client-side code don’t have
 to distinguish between “send a message to the unum” and “send a message
 to the server presence of the unum”. Consequently, they can program to
the conventional model of “send messages to objects on the other end of
the connection” and everything works more or less the way they are used
to.  On the server side, however, things get more interesting.  Here we
encounter something that people accustomed to developing in the web
world have usually never experienced: server code that is simultaneously
 in communication with multiple clients.  This is where working with the
 unum pattern suddenly becomes <em>very</em> different, and also where it acquires much of its power and usefulness.</p>



<p>In the client-server unum model, the server can communicate with all
of an unum’s client presences.  Although a given message could be sent
to any of them, or to all of them, or to any arbitrary subset of them,
in practice we’ve found that a small number of messaging patterns
suffice to capture everything we’ve wanted to do.  More specifically,
there are four patterns that in our experience are repeatedly useful, to
 the point where we’ve codified these in the messaging libraries we use
to implement distributed applications.  We call these four messaging
patterns <em><code>Reply</code></em>, <em><code>Neighbor</code></em>, <em><code>Broadcast</code></em>, and <em><code>Point</code></em>,
 all framed in the context of processing some message that has been
received by the server presence from one of the clients; among other
things, this context identifies which client it was who sent it.  A <code>Reply</code> message is directed back to the client presence that sent the message the server is processing.  A <code>Point</code> message is directed to a specific client presence chosen by the server; this is similar to a <code>Reply</code> message except that the recipient is explicit rather than implied and could be any client regardless of context.  A <code>Broadcast</code> message is sent to all the client presences, while a <code>Neighbor</code> message is directed to all the client presences <em>except</em>
 the sender of the message that the server is processing.  The latter
pattern is the one that people coming to the unum model for the first
time tend to find weird; I’ll explain its use in a moment.</p>



<figure class="wp-block-image"><img src="Habitat%20Chronicles%20%20The%20Unum%20Pattern_files/Fig-3-MessagePatterns-1024x729.png" alt="" class="wp-image-514" ><figcaption>Fig 3 – Message Patterns</figcaption></figure>



<p>(Some people jump to the idea these four are all generalizations of the <code>Point</code>
 message, thinking it a good primitive to actually implement the other
three, but in the systems we’ve built the messaging primitive is a lower
 level construct that handles fanout and routing for one or many
recipients with a single, common mechanism so that we don’t have to
multiply buffer the message if it has more than one target.  In
practice, we use Point messages rather rarely; in fact, using a <code>Point</code> message usually indicates that you’re doing something odd.)</p>



<p>The reason for there being multiple client presences in the first
place is that the presences all share a common context in which the
actions of one client can affect the others.  This is in contrast to the
 classic web model in which each client is engaged in its own one-on-one
 dialog with the server, pretty much unrelated to any simultaneous
dialogs the server might be having with other clients that just happen
to be connected to it at the same time.  However, the
multiple-clients-in-a-shared-context model is a very good match for the
kinds of online game and virtual world applications for which it was
originated (it’s not that you can’t realize those kinds of applications
using the web model, but, like the comment I made above about data
replication, it’s cutting against the grain — it’s not a natural thing
for web servers to do).</p>



<p>Actions initiated by a client typically take the form of a request
message from that client to an unum’s server presence.  The server’s
handler for this message takes whatever actions are appropriate, then
sends a <code>Reply</code> message back informing the requestor of the results of the action, along with a <code>Neighbor</code> message to the other client presences informing them of what just happened. The <code>Reply</code> and <code>Neighbor</code>
 messages generally have different payloads since the requestor
typically already knows what’s going on and often merely needs a status
result, whereas the other clients need to be informed of the action de
novo.  It is also common for the requestor to be a client that is in
some privileged role with respect to the unum (perhaps the sending
client is associated with the unum’s owner or holder, for example), and
thus entitled to be given additional information in the <code>Reply</code> that is not shared with the other clients.</p>



<p>Actions initiated by the server, on the other hand, typically will be communicated to all the clients using the <code>Broadcast</code>
 pattern, since in this case none of the clients start out knowing
what’s going on and thus all require the same information.  The fact
that the server <em>can</em> autonomously initiate actions is another
difference between these kinds of systems and traditional web
applications (server initiated actions are now supported by HTTP/2,
albeit in a strange, inside out kind of way, but as far as I can tell
they have yet to become part of the typical web application developer’s
toolkit).</p>



<p>A direction that some people immediately want to go is to attempt to
reduce the variety of messaging patterns by treating the coordination
among presences as a data replication problem, which I’ve already said
is not what we’re doing here. At the heart of this idea is a sense that
you might make the development of presences simpler by reducing the
differences between them — that rather than developing a client presence
 and a server presence as separate pieces of code, you could have a
single implementation that will serve both ends of the connection (I
can’t count the number of times I’ve seen game companies try to turn
single player games into multiplayer games this way, and the results are
 usually pretty awful).  Alternatively, one could implement one end and
have the other be some kind of standardized one-side-fits-all thing that
 has no type-specific logic of its own.  One issue with either of these
approaches is how you handle the asymmetric information patterns
inherent in the world model, but another is the division of labor
itself.  Systems built on the unum pattern tend to have message
interfaces that are fundamentally about behavior rather than about data.
  That is, what is important about an unum is what it <em>does</em>.
Habitat’s design was driven to a very large degree by the need for it to
 work effectively over 300 and 1200 baud connections.  Behavioral
protocols are vastly more effective at economizing on bandwidth than
data based protocols.  One way to think of this is as a form of highly
optimized, knowledge-based data compression: if you already know what
the possible actions are that can transform the state of something, a
parameterized operation can often be represented much more compactly
than can all state that is changed as a consequence of the action’s
execution.  In some sense, the unum pattern is about as anti-REST as you
 can be.</p>



<p>One idea that I think merits a lot more exploration is this: given
the fundamental idea that an unum’s presences are factored according to a
 division of labor, are there other divisions of labor besides
client-server that might be useful?  I have a strong intuition that the
answer is yes, but I don’t as yet have a lot of justification for that
intuition.  One obvious pattern to look into is a pure peer-to-peer
model, where all presences are equally authoritative and the “true”
state of reality is determined by some kind of distributed consensus
mechanism.  This is a notion we tinkered with a little bit at Electric
Communities, but not to any particular conclusion.  For the moment, this
 remains a research question.</p>



<p>One of the things we <em>did</em> do at Electric Communities was
build a system where the client-server distinction was on a per-unum
basis, rather than “client” and “server” being roles assigned to the two
 ends of a network connection.  To return to our example of a teacup on a
 table in a room, you might have the server presence of the teacup be on
 machine A, with machines B and C acting as clients, while machine B is
the server for the table and machine C is the server for the room.
Obviously, this can only happen if there is N-way connectivity among all
 the participants, in contrast to the traditional two-way connectivity
we use in the web, though whether this is realized via pairwise
connections to a central routing hub or as a true crossbar is left as an
 implementation detail.  This kind of per-unum relationship typing was
one of the keys to our strategy for making our framework support a world
 that was both decentralized and openly extensible.  (Continuing with
the question raised in the last paragraph, an obvious generalization
would be to allow the division of labor scheme itself vary from one unum
 to another.  This suggests that a system whose unums are all initially
structured according to the client-server model could still potentially
act as a test bed for different schemes for dividing up functionality
over the network.)</p>



<figure class="wp-block-image"><img src="Habitat%20Chronicles%20%20The%20Unum%20Pattern_files/Fig-4-VariantServertude-1024x919.png" alt="" class="wp-image-515" ><figcaption>Fig 4 – Variant Servertude</figcaption></figure>



<p>Having the locus of authoritativeness with respect to shared state
vary from one unum to another opens up lots of interesting questions
about the semantics of inter-unum relationships.  In particular, there
is a fairly broad set of issues that at Electric Communities we came to
refer to as “the containership problem”, concerning how to model one
unum containing another when the una are hosted on separate machines,
and especially how to deal with changes in the containership relation.
For example, let’s say we want to take our teacup that’s sitting on the
table and put it into a box that’s on the table next to it.  Is that an
operation on the teacup or on the box?  If we have the teacup be
authoritative about what its container is, it could conceivably teleport
 itself from one place to another, or insert itself into places it
doesn’t belong.  On the other hand, if we have the box be authoritative
about what it contains, then it could claim to contain (or not contain)
anything it decides it wants.  Obviously there needs to be some kind of
handshake between the two (or between the three, if what we’re doing is
moving an unum from one container to another, since both containers may
have an interest — or among the two or three and whatever entity is
initiating the change of containership, since that entity too may have
something to say about things), but what form that handshake takes leads
 to a research program probably worthy of being somebody’s PhD thesis
project.</p>



<p>Setting aside some of these more exotic possibilities for a moment,
we have found the unum pattern to be a powerful and effective tool for
implementing virtual worlds and lots of other applications that have
some kind of world-like flavor, which, once you start looking at things
through a world builder’s lens, is a fairly diverse lot, including smart
 contracts, multi-party negotiations, auctions, chat systems,
presentation and conferencing systems, and, of course, all kinds of
multiplayer games.  And if you dig into some of the weirder things that
we never had the chance to get into in too much depth, I think you have a
 rich universe of possibilities that is still ripe for exploration.</p>
<p class="entry-footer"><a href="http://habitatchronicles.com/category/history/" rel="category tag">History</a> <a href="http://habitatchronicles.com/category/tech/" rel="category tag">Technology</a> <a href="http://habitatchronicles.com/category/theory/" rel="category tag">Theory</a> |
                Posted by Chip at
                <a href="http://habitatchronicles.com/2019/08/the-unum-pattern/">11:42 PM</a> | You can <a href="#respond">comment</a>,
                    or send a
                    <a href="http://habitatchronicles.com/2019/08/the-unum-pattern/trackback/">trackback</a>
                    from your own site.</p>
            </div><a name="comments"></a><h3 class="comments-header">4 Comments</h3>
        <div class="commentlist">
                            <div class="comment" id="comment-117502">
        <div class="comment-content">
            <p>Very cool!  I appreciate this detailed explanation.</p>
<p>As far as Web compatibility, WebSocket closes most of the gap for the
 transport layer.  Now all that’s needed is the object framework (which
should be a Simple Matter of Programming).</p>
        </div>
        <p class="comment-footer">Posted by: Michael FIG |
        <a href="http://habitatchronicles.com/2019/08/the-unum-pattern/#comment-117502">
        August 29, 2019, 12:01 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-117505">
        <div class="comment-content">
            <p>Very interesting, thank you.</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://joyful.com/" rel="external nofollow" class="url">Simon Michael</a> |
        <a href="http://habitatchronicles.com/2019/08/the-unum-pattern/#comment-117505">
        August 29, 2019, 2:10 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-117506">
        <div class="comment-content">
            <p>It strikes me that unums are the inverse of an Avatar.
Whilst the Avatar is your presence in the Populopolis tea room, the unum
 is the teacup’s presence(s) in our world.</p>
<p>Of course, that makes it’s really hard to model relativistic physics
in these virtual worlds because there are lots of “shortcuts” in our
physical world!</p>
<p>Anyway, modern so-called “distributed systems” seems awash with
people who mean “individual objects that were located at different
places on the network” (i.e. “sharded” systems) rather than the more
traditional “objects that were themselves distributed entities” (i.e.
“(multi-master) replicated”; one “thing” appears in lots of places in
potentially different states).</p>
<p>Systems sharded by data are often useful to run code that is
“replicated” (i.e. “duplicated” you run the same piece of code on lots
of different, data). Systems replicated by data are often useful to run
code that is sharded (i.e. “division of labour”. You run slightly
different code on the same (or a subset of, or a restructuring of) data
in different places for different purposes). Most of the current
narrative seems to be about solving the former problem because “big
data”.</p>
<p>I think your date replication / behavioural communication distinction
 is similar to a the code / data distinction in data driven programming,
 but somewhat in reverse: it’s possible to get good communication
efficiencies by describing some transitions in code and referring to
them symbolically rather than programming more generally and driving it
with replicated data.</p>
<p>When extending the division of labour concept to the server side I
think it’s important to know why you’re dividing the labour. Different
servers could be responsible for different rooms whilst teacups might be
 so important that they have their own server. All the room servers
could have a teacup presence but the server specific aspects of the
teacup could be dealt with on the teacup server. If that’s because I
provide teacups for your game then that’s a very different problem than
if you just have a lot of teacups that need their own resources. In many
 ways it becomes similar to the containership problem:</p>
<p>The containership problem seems like it’s to do with the trust of the
 different servers and the trust of the code they run. At the moment
your trust boundary seems like it’s between the client and the servers.
If they’re all run by the same entity then it’s “just” a problem of
managing that cross-cutting concern in the wider codebase. Otherwise,
it’s about preventing me from maliciously teleporting my teacups in to
all sorts of places in your game.</p>
        </div>
        <p class="comment-footer">Posted by: andyjpb |
        <a href="http://habitatchronicles.com/2019/08/the-unum-pattern/#comment-117506">
        August 29, 2019, 2:48 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-117526">
        <div class="comment-content">
            <p>unum here sounds very similar to the idea of an “entity” described here: <a href="https://martinfowler.com/bliki/EvansClassification.html" rel="nofollow">https://martinfowler.com/bliki/EvansClassification.html</a></p>
        </div>
        <p class="comment-footer">Posted by: Douglas |
        <a href="http://habitatchronicles.com/2019/08/the-unum-pattern/#comment-117526">
        August 30, 2019, 3:13 pm</a>
        </p>
    </div>
                       </div>    <form action="http://habitatchronicles.com/blog/wp-comments-post.php" method="post" id="commentform">
    <div class="comments-open">
        <h3 class="comments-open-header">Post a comment</h3>
        <div class="comments-open-content">
            <p class="comments-open-moderated">
                (If you haven't left a comment here before, your comment may
                need to be approved by the site owners before it will appear.
                Thanks for waiting.)
            </p>
            <p><a rel="nofollow" id="cancel-comment-reply-link" href="http://habitatchronicles.com/2019/08/the-unum-pattern/#respond" style="display:none;">Click here to cancel reply.</a></p>
            <div id="comments-open-data">
                <p>
                    <label for="comment-author">Name:</label>
                    <input type="text" id="comment-author" name="author" size="30" tabindex="1">
                </p>
                <p>
                    <label for="comment-email">Email Address: (will not be published)</label>
                    <input id="comment-email" name="email" size="30" tabindex="2">
                </p>
                <p>
                    <label for="comment-url">URL:</label>
                    <input id="comment-url" name="url" size="30" tabindex="3">
                </p>
<!--
                <p>
                    <label for="comment-bake-cookie"><input type="checkbox"
                    id="comment-bake-cookie" name="bakecookie" value="1" />
                    Remember personal info?</label>
                </p> -->
            </div>
            <p id="comments-open-text">
                <label for="comment-text">Your comment: (you may use HTML tags for style)</label>
                <textarea id="comment-text" name="comment" rows="10" cols="80" tabindex="4"></textarea>
            </p>
            <p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="ced1f93a3d"></p><input name="acp-preview" type="button" id="acp-preview" tabindex="6" value="Preview"><div id="ajax-comment-preview">Click the "Preview" button to preview your comment here.</div><p style="display: none;"></p>        </div>
        <div id="comments-open-footer" class="comments-open-footer">
            <input name="submit" type="submit" id="submit" tabindex="5" value="Post"><input type="hidden" name="comment_post_ID" value="511" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">

        </div>
    </div>
    <input type="hidden" id="ak_js" name="ak_js" value="1585295515256"></form><p class="navigate">&lt;&lt; <a href="http://habitatchronicles.com/2019/05/another-thing-found-while-packing-to-move/" rel="prev">Another Thing Found While Packing to Move</a> | </p></div><div id="footer">
   <p>© &nbsp;2020 Chip Morningstar and F. Randall Farmer, all rights reserved.
   </p>
   <script type="text/javascript" src="resources/comment-reply.js"></script>
<script type="text/javascript" src="resources/wp-embed.js"></script>
<script async="async" type="text/javascript" src="resources/form.js"></script>
</div>

</div><!-- container (from header.php) -->


</body></html>