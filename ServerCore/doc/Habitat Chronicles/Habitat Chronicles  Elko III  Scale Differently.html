<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" class=" idcae idcac"><head>
    <title>Habitat Chronicles:   Elko III: Scale Differently</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="content-style-type" content="text/css">
    <meta http-equiv="content-script-type" content="text/javascript">
    <link rel="stylesheet" media="handheld" type="text/css" href="resources/handheld.css">
    <link rel="stylesheet" media="print" type="text/css" href="resources/print.css">
    <link rel="stylesheet" media="screen" type="text/css" href="resources/style_002.css">
    <link rel="stylesheet" type="text/css" media="screen" href="resources/comments.css"><link rel="alternate" type="application/rss+xml" title="Habitat Chronicles RSS Feed" href="http://habitatchronicles.com/feed/">
    <link rel="pingback" href="http://habitatchronicles.com/blog/xmlrpc.php">
    <link rel="dns-prefetch" href="http://s.w.org/">
<link rel="alternate" type="application/rss+xml" title="Habitat Chronicles » Elko III: Scale Differently Comments Feed" href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/feed/">
		<script src="resources/wp-emoji-release.js" type="text/javascript" defer="defer"></script>
		<style type="text/css">
img.wp-smiley,
img.emoji {
	display: inline !important;
	border: none !important;
	box-shadow: none !important;
	height: 1em !important;
	width: 1em !important;
	margin: 0 .07em !important;
	vertical-align: -0.1em !important;
	background: none !important;
	padding: 0 !important;
}
</style>
	<link rel="stylesheet" id="wp-block-library-css" href="resources/style.css" type="text/css" media="all">
<script type="text/javascript" src="resources/jquery.js"></script>
<script type="text/javascript" src="resources/jquery-migrate.js"></script>
<script type="text/javascript">
/* <![CDATA[ */
var AJAXCommentPreview = {"loading":"Loading\u2026","error":"Preview error","emptyString":"Click the \"Preview\" button to preview your comment here.","url":"http:\/\/habitatchronicles.com\/blog\/wp-admin\/admin-ajax.php?action=ajax_comment_preview"};
/* ]]> */
</script>
<script type="text/javascript" src="resources/ajax-comment-preview.js"></script>
<link rel="https://api.w.org/" href="http://habitatchronicles.com/wp-json/">
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://habitatchronicles.com/blog/xmlrpc.php?rsd">
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://habitatchronicles.com/blog/wp-includes/wlwmanifest.xml">
<link rel="prev" title="Elko II: Against Statelessness (or, Everything Old Is New Again)" href="http://habitatchronicles.com/2009/09/elko-ii-against-statelessness-or-everything-old-is-new-again/">
<link rel="next" title="The good news is, I don’t have to move to Seattle" href="http://habitatchronicles.com/2009/09/the-good-news-is-i-dont-have-to-move-to-seattle/">
<link rel="canonical" href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/">
<link rel="shortlink" href="http://habitatchronicles.com/?p=179">
<link rel="alternate" type="application/json+oembed" href="http://habitatchronicles.com/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhabitatchronicles.com%2F2009%2F09%2Felko-iii-scale-differently%2F">
<link rel="alternate" type="text/xml+oembed" href="http://habitatchronicles.com/wp-json/oembed/1.0/embed?url=http%3A%2F%2Fhabitatchronicles.com%2F2009%2F09%2Felko-iii-scale-differently%2F&amp;format=xml">
    <!--[if IE]>
      <style type="text/css">
          div#container {
              max-width:1200px;
              width:expression(document.body.clientWidth > 1200? "1200px": "99%" );
          }
      </style>
    <![endif]-->
</head>
<body>

  <div id="banner">
    <div id="banner-inner" class="pkg">
      <h1 id="banner-header"><a href="http://habitatchronicles.com/">Habitat Chronicles</a></h1>
      <h2 id="banner-description">Cyberspace. Virtual communities. Online games. Distributed systems.<br>Opinion, history, advice, and silliness from two guys who've been building this stuff for a long, long time.</h2>
    </div>
  </div>

  <div id="container">
<div id="navigation">
    <div class="module" style="margin-top: 0;">
        <h2 class="module-header">Say what?</h2>
        <div class="module-content module-content-simple">
    In 1985 we began work on what would become one of the world's first
    multi-person graphical virtual worlds, and arguably the first of what are
    now awkwardly called "Massively Multiplayer Online Role Playing Games"
    (MMORPGs).  Thus began a series of adventures in technology, business, and
    the online world which continue to this day.  This site is where we tell
    our story: the things we learned, the mistakes we made, the people we met,
    a tale of human brilliance and folly and things you would never have
    imagined. <br>
    <br>
    <a href="http://www.fudco.com/chip/resume.html">About Chip Morningstar</a><br>
    <a href="http://www.linkedin.com/in/frandallfarmer">About Randy Farmer</a><br>
    <a href="http://www.fudco.com/chip/lessons.html">About Habitat</a><br>

        </div>
    </div>


    <div class="module">
        <h2 class="module-header">Collected History</h2>
        <div class="module-content">
           <p><a href="http://www.fudco.com/chip/lessons.html">The Lessons of Lucasfilm's Habitat</a></p>
           <p><a href="http://www.fudco.com/chip/deconstr.html">How to Deconstruct Almost Anything</a></p>
           <p><a href="http://habitatchronicles.com/Habitat/historical/HabitatRedux.ppt">MDC 2004: Habitat Redux</a></p>
           <p><a href="http://habitatchronicles.com/Habitat/historical/ProtocolReqs-2-27-95.pdf">1994: Cyberspace Protocol Requirements</a></p>
        </div>
    </div>


    <div class="module"><h2 class="module-header">Blogs We Like</h2><div class="module-content">
	<ul class="xoxo blogroll">
<li><a href="http://www.durhamtownship.com/" title="Chip’s favorite photoblog" target="_blank"><p>A Walk Through Durham Township</p></a></li>
<li><a href="http://citycomfortsblog.typepad.com/" title="Wise meditations on city design — surprisingly relevant to virtual worlds" target="_blank"><p>City Comforts</p></a></li>
<li><a href="http://metamodern.com/" title="Meditations on the future from one of the smartest people on the planet" target="_blank"><p>Eric Drexler</p></a></li>
<li><a href="http://blog.massengale.com/" title="An architect on architecture" target="_blank"><p>John Massengale</p></a></li>
<li><a href="http://www.lessig.org/new-blog/" title="One of the good guys (most of the time)" target="_blank"><p>Lawrence Lessig</p></a></li>
<li><a href="http://www.raphkoster.com/" title="Raph knows more about online gaming than you do.  Just trust us on this." target="_blank"><p>Raph Koster</p></a></li>
<li><a href="http://grumpygamer.com/" title="Our pal and former coworker from Lucasfilm, and one of the best game designers anywhere" target="_blank"><p>Ron Gilbert — Grumpy Gamer</p></a></li>
<li><a href="http://terranova.blogs.com/terra_nova/" title="Where virtual world designers go to die" target="_blank"><p>Terra Nova</p></a></li>
<li><a href="http://classicist.blogs.com/" title="ICA&amp;CA’s house blog, for those of us concerned about the continued health of western culture" target="_blank"><p>The Classicist</p></a></li>
<li><a href="http://thedailywtf.com/" title="IT horrors to make your eyes bleed" target="_blank"><p>The Daily WTF</p></a></li>
<li><a href="https://www.washingtonpost.com/news/volokh-conspiracy/" title="Always interesting, even though they’re all lawyers" target="_blank"><p>The Volokh Conspiracy</p></a></li>
<li><a href="http://vpostrel.com/" title="Contrarian culture blogger non pareil" target="_blank"><p>Virginia Postrel</p></a></li>

	</ul>
</div></div>
<div class="module"><h2 class="module-header">Worthy Things</h2><div class="module-content">
	<ul class="xoxo blogroll">
<li><a href="http://www.crockford.com/" title="Save the earth for valuable prizes!" target="_blank"><p>Douglas Crockford's Wrrrld Wide Web</p></a></li>
<li><a href="http://www.well.com/~doctorow/metacrap.htm" title="Cory speaks truth to utopian W3C weenies" target="_blank"><p>Metacrap</p></a></li>
<li><a href="http://erights.org/" title="Electric Communities’ greatest legacy" target="_blank"><p>The E Programming Language</p></a></li>

	</ul>
</div></div>

    <div class="module">
        <h2 class="module-header">Search</h2>
        <div class="module-content module-content-simple">
            <form method="get" id="searchform" action="http://habitatchronicles.com">
    <fieldset>
        <label for="s">
            Habitat Chronicles search
            <br>
            <input type="text" size="20" name="s" id="s">
            <input type="submit" id="searchsubmit" value="Search">
        </label>
    </fieldset>
</form>
        </div>
    </div>

    <div class="module">
        <h2 class="module-header">Categories</h2>
        <div class="module-content module-content-simple">
            <ul>
                	<li class="cat-item cat-item-3"><a href="http://habitatchronicles.com/category/administrivia/">Administrivia</a>
</li>
	<li class="cat-item cat-item-4"><a href="http://habitatchronicles.com/category/avatar/">Avatar</a>
</li>
	<li class="cat-item cat-item-5"><a href="http://habitatchronicles.com/category/biz/">Business</a>
</li>
	<li class="cat-item cat-item-6"><a href="http://habitatchronicles.com/category/education/">Education</a>
</li>
	<li class="cat-item cat-item-7"><a href="http://habitatchronicles.com/category/elsewhere/">Elsewhere</a>
</li>
	<li class="cat-item cat-item-8"><a href="http://habitatchronicles.com/category/food/">Food</a>
</li>
	<li class="cat-item cat-item-9"><a href="http://habitatchronicles.com/category/general/">General</a>
</li>
	<li class="cat-item cat-item-10"><a href="http://habitatchronicles.com/category/history/">History</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://habitatchronicles.com/category/lessons-learned/">Lessons Learned</a>
</li>
	<li class="cat-item cat-item-12"><a href="http://habitatchronicles.com/category/news/">News</a>
</li>
	<li class="cat-item cat-item-13"><a href="http://habitatchronicles.com/category/open/">Open</a>
</li>
	<li class="cat-item cat-item-14"><a href="http://habitatchronicles.com/category/politics/">Politics</a>
</li>
	<li class="cat-item cat-item-15"><a href="http://habitatchronicles.com/category/random/">Random Lunacy</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://habitatchronicles.com/category/random-lunacy/">Random Lunacy</a>
</li>
	<li class="cat-item cat-item-16"><a href="http://habitatchronicles.com/category/speaking/">Speaking</a>
</li>
	<li class="cat-item cat-item-17"><a href="http://habitatchronicles.com/category/tech/">Technology</a>
</li>
	<li class="cat-item cat-item-18"><a href="http://habitatchronicles.com/category/theory/">Theory</a>
</li>
	<li class="cat-item cat-item-1"><a href="http://habitatchronicles.com/category/uncategorized/">Uncategorized</a>
</li>
            </ul>
        </div>
    </div>

    <div class="module">
        <h2 class="module-header">Archives</h2>
        <div class="module-content module-content-simple">
            <ul>
                	<li><a href="http://habitatchronicles.com/2019/08/">August 2019</a></li>
	<li><a href="http://habitatchronicles.com/2019/05/">May 2019</a></li>
	<li><a href="http://habitatchronicles.com/2019/03/">March 2019</a></li>
	<li><a href="http://habitatchronicles.com/2018/01/">January 2018</a></li>
	<li><a href="http://habitatchronicles.com/2017/11/">November 2017</a></li>
	<li><a href="http://habitatchronicles.com/2017/05/">May 2017</a></li>
	<li><a href="http://habitatchronicles.com/2017/02/">February 2017</a></li>
	<li><a href="http://habitatchronicles.com/2016/10/">October 2016</a></li>
	<li><a href="http://habitatchronicles.com/2014/10/">October 2014</a></li>
	<li><a href="http://habitatchronicles.com/2014/04/">April 2014</a></li>
	<li><a href="http://habitatchronicles.com/2014/03/">March 2014</a></li>
	<li><a href="http://habitatchronicles.com/2014/02/">February 2014</a></li>
	<li><a href="http://habitatchronicles.com/2013/12/">December 2013</a></li>
	<li><a href="http://habitatchronicles.com/2013/10/">October 2013</a></li>
	<li><a href="http://habitatchronicles.com/2013/08/">August 2013</a></li>
	<li><a href="http://habitatchronicles.com/2012/07/">July 2012</a></li>
	<li><a href="http://habitatchronicles.com/2011/04/">April 2011</a></li>
	<li><a href="http://habitatchronicles.com/2011/03/">March 2011</a></li>
	<li><a href="http://habitatchronicles.com/2011/01/">January 2011</a></li>
	<li><a href="http://habitatchronicles.com/2010/11/">November 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/10/">October 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/07/">July 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/03/">March 2010</a></li>
	<li><a href="http://habitatchronicles.com/2010/02/">February 2010</a></li>
	<li><a href="http://habitatchronicles.com/2009/12/">December 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/10/">October 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/09/">September 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/08/">August 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/07/">July 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/03/">March 2009</a></li>
	<li><a href="http://habitatchronicles.com/2009/02/">February 2009</a></li>
	<li><a href="http://habitatchronicles.com/2008/12/">December 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/11/">November 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/10/">October 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/09/">September 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/08/">August 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/06/">June 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/02/">February 2008</a></li>
	<li><a href="http://habitatchronicles.com/2008/01/">January 2008</a></li>
	<li><a href="http://habitatchronicles.com/2007/09/">September 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/07/">July 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/06/">June 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/05/">May 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/03/">March 2007</a></li>
	<li><a href="http://habitatchronicles.com/2007/01/">January 2007</a></li>
	<li><a href="http://habitatchronicles.com/2006/12/">December 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/11/">November 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/10/">October 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/09/">September 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/08/">August 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/06/">June 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/05/">May 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/03/">March 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/02/">February 2006</a></li>
	<li><a href="http://habitatchronicles.com/2006/01/">January 2006</a></li>
	<li><a href="http://habitatchronicles.com/2005/12/">December 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/11/">November 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/10/">October 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/09/">September 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/08/">August 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/05/">May 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/04/">April 2005</a></li>
	<li><a href="http://habitatchronicles.com/2005/03/">March 2005</a></li>
	<li><a href="http://habitatchronicles.com/2004/11/">November 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/10/">October 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/09/">September 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/07/">July 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/05/">May 2004</a></li>
	<li><a href="http://habitatchronicles.com/2004/04/">April 2004</a></li>
            </ul>
        </div>
    </div>

    <div class="module">
        <h2 class="module-header">Feed</h2>
        <div class="module-content module-content-simple">
            <ul class="rss">
                <li><a href="http://habitatchronicles.com/feed/" title="Feed for articles" style="text-decoration:none;">Subscribe to this blog's feed&nbsp;&nbsp;<img src="resources/feed-icon-28x28.png" alt="Feed" style="vertical-align:middle;" width="28" height="28"></a></li>
            </ul>
        </div>
    </div>

</div>
<div id="content"><h2 class="date-header">September 7, 2009</h2><div class="post-179 post type-post status-publish format-standard hentry category-tech" id="post-179">
                <h3>Elko III: Scale Differently</h3>
                <p> <i>Preface: This is the third of three posts on
Elko, a server platform for sessionful, stateful web applications that
I’m releasing this week as open source software. Earlier, <a href="http://habitatchronicles.com/2009/09/elko-i-the-life-death-life-death-life-death-and-resurrection-of-the-elko-session-sever/">Part I</a> presented the business backstory for Elko.  <a href="http://habitatchronicles.com/2009/09/elko-ii-against-statelessness-or-everything-old-is-new-again/">Part II</a>,
 yesterday’s post, presented the technical backstory, laying out the key
 ideas that lead to the thing.  Today’s post presents a more detailed
technical explication of the system itself, with particular emphasis on
the scaling model that enables it all to work effectively.</i></p>
<p> In Part II I ranted at length about some of the unfortunate
consequences of the doctrine of statelessness, the predominant paradigm
for scaling web applications.  Keeping the short-term state of a
client-server session in the server’s memory is easy and therefor
tempting, but, the story goes, you shouldn’t do that because it means
you can’t scale your application — you just can’t handle the traffic
from thousands or millions of users on the single machine whose memory
it would be.</p>
<p> But this isn’t so much a server capacity problem as it is a traffic
routing problem.  In a traditional web server farm, load is distributed
across multiple servers by arranging for successive HTTP requests to a
particular named host to be delivered to different servers. Typically
this is accomplished through provision of multiple IP addresses in the
DNS resolution of the host name or through special load balancing
routers in the server datacenter that virtualize the nominal host IP
address, directing successive TCP sessions to different machines on the
datacenter’s internal network.</p>
<p> This technique has a number of virtues, not least of which is that
it is relatively simple.  It takes advantage of the expectation that the
 loads that successive HTTP requests are going to place on the servers
are likely to be uncorellated, and thus delivering requests to servers
on a simple round-robin schedule, or even randomly, will, through the
statistical magic of large numbers, result in more or less even load
distribution across the datacenter. This lack of correlation is usually a
 reasonable assumption, since the various browsers hitting a given site
around the same time are, for most sites, uncoordinated (indeed, the
deliberate coordination of such activity is the basis for a major class
of denial of service attacks).</p>
<p> However, just as this scheme implies that a given browser has no
control over (nor ability to predict) which server machine it’s actually
 going to be talking to when it sends an HTTP request, it similarly
means that a given server has no say over which clients it will be
servicing.  Any service implementation that relies on local data
coherence from one request to the next (other than of a statistical
nature, as is exploited by caching) is thus doomed.  Keeping session
state in the server’s memory is right out.</p>
<p> Elko approaches the scaling problem in a different way.  First of all, we embrace the concept of a <i>session</i>:
 a series of interactions between the client and the server that has a
beginning, a middle, and an end.  This is by no means an exotic
abstraction; indeed, the TCP protocol that HTTP is layered on top of is
sessionful in exactly this way.  However, HTTP then takes the session
abstraction away from us, leaving it to the web application framework
(of which, in this sense, Elko is just one of many) to pile on a bunch
of additional mechanism to put it back in again.</p>
<p> Whereas, from the client’s perspective, a TCP session represents a
communications connection to a particular host on the network, an Elko
session represents a communications connection to a particular <i>context</i>.
  Like a web page, a context has a distinct, addressable identity.
Unlike a web page, a context has its own computational existence
independent of who is communicating with it at any given moment.  In
particular, multiple clients can interact with a given context at the
same time, and the context itself can act independent of any of its
individual clients, including when there are no clients at all.  For
example, in a multi-user chat application, the contexts would most
likely be chat rooms.  In a real-time auction application, contexts
might represent the various auctions that are going on.</p>
<p> The Elko platform provides several different types of servers, all
based on a common set of building blocks.  However, for purposes of the
present discussion, there are two that matter: the <i>Context Server</i> and the <i>Director</i>.</p>
<p> A <i>Context Server</i> provides an environment in which contexts
run.  Context Servers are generic and fungible in the same kinds of ways
 that web servers are: need more capacity? Just add more servers.  The
difference in the scaling story is that rather than handling load by
farming out HTTP requests amongst multiple web servers, the Elko
approach is to farm out contexts amongst multiple Context Servers.</p>
<p> In Elko, a context can be said to be active or inactive.  An
inactive context is saved in persistent storage, such as a file or a
database.  An active context exists in the process and memory space of
some Context Server.  The job of the <i>Director</i> is to keep track of
 which contexts are active and, when active, which Context Server each
one is running on.  When a client wishes to enter a particular context
(that is, initiate a communications connection to it), the client sends a
 request to a Director asking where to go (these requests are routed to
Directors using the kinds of standard web scaling techniques described
above).  If the context is active, the Director replies to the client
with the address of the Context Server upon which the context is running
 (and notifies the Context Server to expect the client’s arrival),
rather like this: <img src="Habitat%20Chronicles%20%20Elko%20III%20%20Scale%20Differently_files/ActiveContext.png" alt="ActiveContext" title="ActiveContext" class="aligncenter size-full wp-image-181" width="364" height="361"></p>
<p> If the context is not active, the Director picks a Context Server to
 run the context, replies to the client with the address of this Context
 Server, and sends the chosen Context Server a message commanding it to
activate the context, like this: <img src="Habitat%20Chronicles%20%20Elko%20III%20%20Scale%20Differently_files/InactiveContext.png" alt="InactiveContext" title="InactiveContext" class="aligncenter size-full wp-image-182" width="365" height="400"></p>
<p> (Note that there is a race between the client arriving at the
Context Server and the Context Server loading the context, but the
implementation ensures that this is taken care of.)</p>
<p> Unlike the members of a cluster of traditional web servers, the
address of each Context Server is fixed.  Thus, once the client
connection to a particular Context’s Server is made, the client
communicates with the same Context Server for all of its interaction
needs in that context for as long as the session lasts.  This means the
Context Server can keep the context state in memory, only going to
persistent storage as needed for checkpointing long-term application
state.  Once the last client exits a context, that context can be
unloaded and the server capacity made available for other contexts.</p>
<p> The Context Servers keep the Directors aprised of the contexts they
are handling, the clients that are in those contexts, and the server
load they are currently experiencing.  From this information, the
Directors can route client traffic by context or by user (e.g., in a
chat application, I may want to enter the chat room where my friends
are, rather than a specific room whose identity I know a priori), and
can identify the least heavily loaded servers for new context
activation.</p>
<p> Directors can be replicated for scale and redundancy, but since they
 actually do very little work, one Director can handle the load for a
large number of clients before capacity becomes an issue.  Director
scalability is also enhanced because servicing clients only makes
reference to in-memory data structures, so everything the Director does
is very fast and has quick turnaround.</p>
<p> This scheme scales very well.  Because it has a very light footprint
 and services nearly everything from memory, even a single Context
Server can manage a substantial load.  We benchmarked the SAF Context
Server, which had the identical architecture, in 2002 at Sun’s
performance testing center in Menlo Park. On a Sun Enterprise 450 server
 (2 processor 400Mhz SPARC, a mid- to low-range machine even then), we
ran a simulated chat environment, running 8000 concurrent connections
spread over ~200 chat rooms, with an average fanout per room of ~40
users, with each client producing an utterances approximately every 30
seconds (in a 40 user chat room, that level of activity is positively
frantic).  This resulted in about 20% CPU load with no user detectable
lag. Ironically, the biggest challenge in performing this test was
generating enough load.  We ended up having to use several of the
biggest machines they had in the lab to run the client side of the test.
  Note also that this test was conducted three or four generations of
server hardware ago.  I expect that on modern machines, these numbers
will be even more substantial.</p>
<p> One potential criticism of this scaling strategy is that it is more
complicated than the way web servers usually do things.  On the surface,
 I have to concede that that is true.  However, by the time you take
into consideration the extra work you need to do in an actual
large-scale web setup, configuring routers and load balancers and <code>memcache</code>
 servers and database clusters and endless other complications, plus all
 the extra application engineering work to make use of these, I think
Elko ends up being a simpler configuration.  I know from experience that
 it’s a vastly simpler environment for the application coder.</p>
<p> So that’s the theorical side of the scaling story.  I invite anyone
who has an interest in delving deeper to check things out for
themselves.  The code is <a href="http://www.fudco.com/software/elko/">here</a>.</p>
<p class="entry-footer"><a href="http://habitatchronicles.com/category/tech/" rel="category tag">Technology</a> |
                Posted by Chip at
                <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/">7:30 PM</a> | You can <a href="#respond">comment</a>,
                    or send a
                    <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/trackback/">trackback</a>
                    from your own site.</p>
            </div><a name="comments"></a><h3 class="comments-header">10 Comments</h3>
        <div class="commentlist">
                            <div class="comment" id="comment-234">
        <div class="comment-content">
            <p>Chip,</p>
<p>in addition to scalability, the other argument often used for
“traditional” web architectures is built-in redundancy and
fault-tolerance. In the Elko architecture, how do you make the Director
fault-tolerant?</p>
        </div>
        <p class="comment-footer">Posted by: Chris Lauwers |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-234">
        September 10, 2009, 2:04 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-235">
        <div class="comment-content">
            <p>Chris, I guess I implied the answer but I should have
been clearer about that.  You make the Director fault tolerant through
simple redundancy — just set up multiple Directors. At State Software,
our standard configuration was 2 Directors, and this was for fault
tolerance rather than scaling.  You can have as many Directors as you
like, though more than 2 or 3 is probably overkill.  Client traffic to
the multiple Directors is then routed using rotating DNS or a VIP, just
as you would with a regular web server cluster.</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://www.fudco.com/chip" rel="external nofollow" class="url">Chip Morningstar</a> |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-235">
        September 11, 2009, 9:19 am</a>
        </p>
    </div>
        <div class="comment" id="comment-236">
        <div class="comment-content">
            <p>Yes, I should have been more specific: my question has to
 do with replicating state between multiple Directors. Do you use a
shared database for this?</p>
        </div>
        <p class="comment-footer">Posted by: Chris Lauwers |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-236">
        September 11, 2009, 10:33 am</a>
        </p>
    </div>
        <div class="comment" id="comment-237">
        <div class="comment-content">
            <p>All the Directors’ data structures are non-persistent.
When Context Servers come up they notify the Directors of their
availability to provide services.  They then keep the Directors informed
 of their ongoing availability and load status.  In addition, there’s a
protocol whereby the Directors keep each other updated about their own
statuses, so that they can also go up and down, and so that new
Directors can be added to the cluster dynamically.</p>
<p>There’s also a more complex configuration, not described in my post
but covered in some of the docs in the release package (though I will
confess that here things could benefit from more documentation love),
where there’s an additional kind of server called a Broker that keeps
track of a heterogeneous collection of Elko servers and the various
services they offer to other servers in the farm.  The Broker acts as a
kind of configuration manager, so that each server only needs to know
one point of contact to get wired up with everybody else.</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://www.fudco.com/chip" rel="external nofollow" class="url">Chip</a> |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-237">
        September 11, 2009, 2:48 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-558">
        <div class="comment-content">
            <p>Maybe I am missing something completely (which is most
likely), but what is the difference between this and a traditional web
architectures with sticky session turned on ? When you say “client”, is
that the browser client ? or both browser and server which are clients
to this context framework ?</p>
<p>ps: The build up was great in the part II, but this part was a total let down (atleast for thick heads like me)</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://www.tweetaboogle.com/" rel="external nofollow" class="url">Victor Doss</a> |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-558">
        September 3, 2010, 12:35 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-560">
        <div class="comment-content">
            <p>Victor, that’s a very reasonable question.  There is some
 similarity, and to the extent that one’s application entails a single
client’s interaction with it’s own autistic session state, they are
basically the same thing.  However, there are a couple of points of
differentiation that matter to a broader range of applications.  The
most important is that multiple clients can be readily routed to a
common session context containing shared state that is relevant to all
of them.  The canonical example is a real-time, multiplayer game, but
you might also consider auctions, shared graphical workspaces, or live
online slide presentations — anything where lively shared data that
spans multiple client sessions would be of value.  Another notable
differentiator, less profound but still useful pragmatically, is the
shift in perspective that arises when you regard the client-server
connection as a channel to a process rather than to a purely reactive
object.  That’s a little abstract, so let me dig into it a bit more: a
conventional web server is designed to act by responding to each HTTP
request as it is delivered.  Elko does that also, but since it decouples
 the HTTP request/response handshake from the application message
protocol, it can also initiate communication to the client
asynchronously.  Timers and other processes can run autonomously on the
server and then send messages to the client when they feel the need to
do so.  For example, an auction application might close bidding after
the passage of sufficient time with no new bids submitted — and then
notify everyone participating in the auction that this has happened.
All of that can (and has been) done with a conventional web server also,
 but it cuts against the grain and requires jumping through a few hoops,
 whereas Elko does this natively.</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://www.fudco.com/chip" rel="external nofollow" class="url">Chip</a> |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-560">
        September 6, 2010, 9:40 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-562">
        <div class="comment-content">
            <p>Thanks for the clarification. I am sold now. Actually I
was sold when i read i have to use “make” to build it :-) Just wanted to
 make sure I am using for right application.</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://www.tweetaboogle.com/" rel="external nofollow" class="url">Victor Doss</a> |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-562">
        September 11, 2010, 10:11 am</a>
        </p>
    </div>
        <div class="comment" id="comment-86427">
        <div class="comment-content">
            <p>How does this work in the context of an auto-scaling
cluster of context servers, where servers can be brought online or taken
 off as load demands? There would need to be a mechanism for
transferring live contexts from one server to another, e.g. when two
lightly loaded servers are merged so that one can be taken offline, or
when balancing load onto a newly-spawned server instance.</p>
        </div>
        <p class="comment-footer">Posted by: Anson Mansfield |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-86427">
        July 17, 2016, 4:30 pm</a>
        </p>
    </div>
        <div class="comment" id="comment-86429">
        <div class="comment-content">
            <p>That’s a really interesting question.  There are a couple
 of approaches, neither of which are in the current implementation but
both of which have been in my things-that-might-be-worth-doing list for a
 while now.</p>
<p>The easy approach is a simple wait-for-quiescence strategy: In a lot
of applications, contexts tend to be comparatively short lived.  In this
 case, a server can be taken down in two steps: first, it notifies the
Director that it is no longer offering service, then it waits for its
current batch of contexts to become inactive.  Once they’re all gone, it
 can exit cleanly.  Obviously, this is problematic if contexts don’t
eventually go away, either because they really are long lived or if
somebody is just perversely hanging on for a long time.  Some
applications can tolerate loss of context state at the cost of some
minor user inconvenience, and in such cases you can simply kick the
recalcitrant users off (if they reconnect, they’ll reactivate the
context on a different server and all will be well again, absent any
loss of state that might have happened).  Of course, if you can’t do
that, you’ll have to go to the harder approach.</p>
<p>The hard approach is context migration.  This is hard because it requires a general object serialization scheme.  However, it <i>is</i>
 quite feasible (we did something like this at Electric Communities, and
 it worked fine).  It’s feasible because of the turn based message
execution model and because contexts generally have an isolated object
graph.  So you can stop the world between messages, serialize the
context, ship it to another server, and redirect clients to the new
server.  The connection handoff logic is a bit hairy, and the
serialization stuff is a lot of work, both of which are the reasons why
this isn’t currently implemented yet (that, and because in practice we
haven’t encountered use cases that demanded it, though that in turn may
be due to the relatively light adoption of the Elko approach to things).
 </p>
<p>Note that adding capacity to a cluster is comparatively easy — just
spin up more context servers.  Since we do true load balancing (in
contrast to traffic balancing, which is what most web solutions are
doing when they claim to be load balancing), we’re in a position to
simply not put more load on a given machine than it can handle, so it’s
less imperative to spread existing load when adding new servers.
Instead, adding new servers simply increases the number of contexts that
 can be activated.</p>
        </div>
        <p class="comment-footer">Posted by: <a href="http://www.fudco.com/chip" rel="external nofollow" class="url">Chip</a> |
        <a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-86429">
        July 17, 2016, 6:39 pm</a>
        </p>
    </div>
                       </div><h3 class="comments-header" id="pings">Trackbacks/Pingbacks</h3>
        <ol class="pinglist">
            		<li class="pingback even thread-even depth-1" id="comment-559">
				<div id="div-comment-559" class="comment-body">
				<div class="comment-author vcard">
						<cite class="fn"><a href="http://www.subbu.org/blog/2010/09/javascript-and-http" rel="external nofollow" class="url">JavaScript and HTTP</a></cite> <span class="says">says:</span>		</div>

		<div class="comment-meta commentmetadata"><a href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#comment-559">
			September 6, 2010 at 7:42 pm				</a>
						</div>

		<p>[…] client to a given server that maintains state in memory. In
addition to Chip Morningstar’s post on Elko, see JSON Messaging Over
HTTP that explains what happens at the HTTP level. The client […]</p>


				</div>
				</li><!-- #comment-## -->
        </ol>    <form action="http://habitatchronicles.com/blog/wp-comments-post.php" method="post" id="commentform">
    <div class="comments-open">
        <h3 class="comments-open-header">Post a comment</h3>
        <div class="comments-open-content">
            <p class="comments-open-moderated">
                (If you haven't left a comment here before, your comment may
                need to be approved by the site owners before it will appear.
                Thanks for waiting.)
            </p>
            <p><a rel="nofollow" id="cancel-comment-reply-link" href="http://habitatchronicles.com/2009/09/elko-iii-scale-differently/#respond" style="display:none;">Click here to cancel reply.</a></p>
            <div id="comments-open-data">
                <p>
                    <label for="comment-author">Name:</label>
                    <input type="text" id="comment-author" name="author" size="30" tabindex="1">
                </p>
                <p>
                    <label for="comment-email">Email Address: (will not be published)</label>
                    <input id="comment-email" name="email" size="30" tabindex="2">
                </p>
                <p>
                    <label for="comment-url">URL:</label>
                    <input id="comment-url" name="url" size="30" tabindex="3">
                </p>
<!--
                <p>
                    <label for="comment-bake-cookie"><input type="checkbox"
                    id="comment-bake-cookie" name="bakecookie" value="1" />
                    Remember personal info?</label>
                </p> -->
            </div>
            <p id="comments-open-text">
                <label for="comment-text">Your comment: (you may use HTML tags for style)</label>
                <textarea id="comment-text" name="comment" rows="10" cols="80" tabindex="4"></textarea>
            </p>
            <p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="6a24cbed92"></p><input name="acp-preview" type="button" id="acp-preview" tabindex="6" value="Preview"><div id="ajax-comment-preview">Click the "Preview" button to preview your comment here.</div><p style="display: none;"></p>        </div>
        <div id="comments-open-footer" class="comments-open-footer">
            <input name="submit" type="submit" id="submit" tabindex="5" value="Post"><input type="hidden" name="comment_post_ID" value="179" id="comment_post_ID">
<input type="hidden" name="comment_parent" id="comment_parent" value="0">

        </div>
    </div>
    <input type="hidden" id="ak_js" name="ak_js" value="1585295231034"></form><p class="navigate">&lt;&lt; <a href="http://habitatchronicles.com/2009/09/elko-ii-against-statelessness-or-everything-old-is-new-again/" rel="prev">Elko II: Against Statelessness (or, Everything Old Is New Again)</a> |  <a href="http://habitatchronicles.com/2009/09/the-good-news-is-i-dont-have-to-move-to-seattle/" rel="next">The good news is, I don’t have to move to Seattle</a> &gt;&gt;</p></div><div id="footer">
   <p>© &nbsp;2020 Chip Morningstar and F. Randall Farmer, all rights reserved.
   </p>
   <script type="text/javascript" src="resources/comment-reply.js"></script>
<script type="text/javascript" src="resources/wp-embed.js"></script>
<script async="async" type="text/javascript" src="resources/form.js"></script>
</div>

</div><!-- container (from header.php) -->


</body></html>